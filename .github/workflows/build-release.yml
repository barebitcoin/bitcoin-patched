name: Build and Release

on:
  pull_request:
  push:
  workflow_dispatch:

env:
  # Branches that trigger uploads to releases.drivechain.info
  RELEASE_BRANCHES: |
    master
    forknet

jobs:
  check-release:
    name: Check if release upload needed
    runs-on: ubuntu-latest
    outputs:
      should-upload: ${{ steps.check.outputs.should-upload }}
    steps:
      - name: Check branch against release list
        id: check
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Release branches:"
          echo "${{ env.RELEASE_BRANCHES }}"
          echo "---"

          if [ "${{ github.event_name }}" != "push" ]; then
            echo "::notice::Skipping upload: not a push event"
            echo "should-upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.repository_owner }}" != "LayerTwo-Labs" ]; then
            echo "::notice::Skipping upload: not LayerTwo-Labs repo"
            echo "should-upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          RELEASE_BRANCHES="${{ env.RELEASE_BRANCHES }}"
          if echo "$RELEASE_BRANCHES" | grep -qx "${{ github.ref_name }}"; then
            echo "::notice::Will upload: branch '${{ github.ref_name }}' is in release list"
            echo "should-upload=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Skipping upload: branch '${{ github.ref_name }}' not in release list"
            echo "should-upload=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: ${{ matrix.timeout }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-24.04
            timeout: 120
            artifact-suffix: x86_64-unknown-linux-gnu
            exe-ext: ""
            build-subdir: ""
          - platform: windows
            os: windows-2022
            timeout: 360
            artifact-suffix: x86_64-w64-msvc
            exe-ext: ".exe"
            build-subdir: "Release/"
          - platform: macos
            os: macos-15-intel
            timeout: 120
            artifact-suffix: x86_64-apple-darwin
            exe-ext: ""
            build-subdir: ""

    steps:
      - uses: actions/checkout@v4

      # Set branch suffix for artifact names (empty on master, branch name otherwise)
      - name: Set artifact branch suffix
        shell: bash
        run: |
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "BRANCH_SUFFIX=" >> "$GITHUB_ENV"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # Sanitize branch name (replace / with -)
            BRANCH=$(echo "${{ github.head_ref }}" | sed 's/\//-/g')
            echo "BRANCH_SUFFIX=-${BRANCH}" >> "$GITHUB_ENV"
          else
            # Push to non-master branch
            BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
            echo "BRANCH_SUFFIX=-${BRANCH}" >> "$GITHUB_ENV"
          fi

      #
      # Platform-specific setup
      #
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libboost-dev \
              libevent-dev qtbase5-dev qttools5-dev \
              qttools5-dev-tools qtwayland5

      - name: Install macOS dependencies
        if: matrix.platform == 'macos'
        run: |
          # GNU grep is required, as BSD grep does not support perl regexes
          brew install boost grep qrencode qt@5

      # Windows: Configure MSVC
      - name: Configure Developer Command Prompt for Microsoft Visual C++
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Get Windows tool information
        if: matrix.platform == 'windows'
        run: |
          cmake -version | Tee-Object -FilePath "cmake_version"
          Write-Output "---"
          msbuild -version | Tee-Object -FilePath "msbuild_version"
          $env:VCToolsVersion | Tee-Object -FilePath "toolset_version"
          py -3 --version
          Write-Host "PowerShell version $($PSVersionTable.PSVersion.ToString())"

      - name: Configure vcpkg for Windows
        if: matrix.platform == 'windows'
        run: |
          Set-Location "$env:VCPKG_INSTALLATION_ROOT"
          Add-Content -Path "triplets\x64-windows.cmake" -Value "set(VCPKG_BUILD_TYPE release)"
          Add-Content -Path "triplets\x64-windows-static.cmake" -Value "set(VCPKG_BUILD_TYPE release)"

      #
      # Cache handling
      #
      - name: Restore depends cache (Linux/macOS)
        if: matrix.platform != 'windows'
        uses: actions/cache/restore@v4
        with:
          path: ./depends
          key: ${{ matrix.platform }}-${{ hashFiles('depends/packages/**') }}

      - name: Restore vcpkg tools cache (Windows)
        if: matrix.platform == 'windows'
        uses: actions/cache@v4
        with:
          path: C:/vcpkg/downloads/tools
          key: ${{ github.job }}-vcpkg-tools

      - name: Restore vcpkg binary cache (Windows)
        if: matrix.platform == 'windows'
        uses: actions/cache/restore@v4
        id: vcpkg-binary-cache
        with:
          path: ~/AppData/Local/vcpkg/archives
          key: ${{ github.job }}-vcpkg-binary-${{ hashFiles('cmake_version', 'msbuild_version', 'toolset_version', 'vcpkg.json') }}

      #
      # Build dependencies (Linux/macOS only - Windows uses vcpkg)
      #
      - name: Download dependencies (Linux)
        if: matrix.platform == 'linux'
        run: make -C ./depends download-linux

      - name: Download dependencies (macOS)
        if: matrix.platform == 'macos'
        run: make -C ./depends download-osx

      - name: Build dependencies (Linux/macOS)
        if: matrix.platform != 'windows'
        run: make -C ./depends -j4

      - name: Save depends cache (Linux/macOS)
        if: matrix.platform != 'windows'
        uses: actions/cache/save@v4
        with:
          path: ./depends
          key: ${{ matrix.platform }}-${{ hashFiles('depends/packages/**') }}

      #
      # Configure and build
      #
      - name: Configure build (Linux)
        if: matrix.platform == 'linux'
        run: cmake -B build --toolchain depends/x86_64-pc-linux-gnu/toolchain.cmake

      - name: Configure build (macOS)
        if: matrix.platform == 'macos'
        run: cmake -B build -DBUILD_GUI=ON --toolchain depends/x86_64-apple-darwin*/toolchain.cmake

      - name: Configure build (Windows)
        if: matrix.platform == 'windows'
        run: |
          cmake -B build --preset vs2022-static `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DBUILD_GUI=ON -DWITH_BDB=OFF -DWITH_ZMQ=ON `
            -DBUILD_BENCH=OFF -DBUILD_FUZZ_BINARY=OFF -DBUILD_TESTS=OFF -DBUILD_UTIL=ON

      - name: Save vcpkg binary cache (Windows)
        if: matrix.platform == 'windows' && github.event_name != 'pull_request' && steps.vcpkg-binary-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ~/AppData/Local/vcpkg/archives
          key: ${{ github.job }}-vcpkg-binary-${{ hashFiles('cmake_version', 'msbuild_version', 'toolset_version', 'vcpkg.json') }}

      - name: Build (Linux/macOS)
        if: matrix.platform != 'windows'
        run: cmake --build build -j4

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        run: cmake --build build -j $env:NUMBER_OF_PROCESSORS --config Release

      #
      # Extract version and prepare artifacts
      #
      - name: Set version environment variable
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "macos" ]; then
            VERSION=$(ggrep -oP "(?<=^CMAKE_PROJECT_VERSION:STATIC=).+(?=)" build/CMakeCache.txt)
          else
            VERSION=$(grep -oP "(?<=^CMAKE_PROJECT_VERSION:STATIC=).+(?=$)" build/CMakeCache.txt || \
                      grep CMAKE_PROJECT_VERSION:STATIC build/CMakeCache.txt | cut -d= -f2)
          fi
          echo "BITCOIN_PATCHED_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts/qt
          mv "build/bin/${{ matrix.build-subdir }}bitcoind${{ matrix.exe-ext }}" artifacts/
          mv "build/bin/${{ matrix.build-subdir }}bitcoin-cli${{ matrix.exe-ext }}" artifacts/
          mv "build/bin/${{ matrix.build-subdir }}bitcoin-util${{ matrix.exe-ext }}" artifacts/
          mv "build/bin/${{ matrix.build-subdir }}bitcoin-qt${{ matrix.exe-ext }}" artifacts/qt/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bitcoin-patched-${{ env.BITCOIN_PATCHED_VERSION }}${{ env.BRANCH_SUFFIX }}-${{ matrix.artifact-suffix }}
          if-no-files-found: error
          path: |
            artifacts/bitcoind${{ matrix.exe-ext }}
            artifacts/bitcoin-cli${{ matrix.exe-ext }}
            artifacts/bitcoin-util${{ matrix.exe-ext }}
            artifacts/qt/bitcoin-qt${{ matrix.exe-ext }}

  upload-artifacts-to-releases-drivechain-info:
    name: Upload artifacts to releases.drivechain.info
    runs-on: ubuntu-latest
    needs: [check-release, build]
    if: needs.check-release.outputs.should-upload == 'true'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Determine version label
        id: version
        run: |
          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "label=latest" >> "$GITHUB_OUTPUT"
          else
            # Sanitize branch name for filename
            BRANCH=$(echo "${{ github.ref_name }}" | sed 's/\//-/g')
            echo "label=${BRANCH}" >> "$GITHUB_OUTPUT"
          fi

      - name: Zip artifacts
        run: |
          set -euo pipefail
          ARTIFACT_PREFIX="L1-bitcoin-patched-${{ steps.version.outputs.label }}"

          for suffix in x86_64-apple-darwin x86_64-w64-msvc x86_64-unknown-linux-gnu; do
            # Find the artifact directory (may have version and branch suffix)
            src_dir=$(ls -d bitcoin-patched-*-${suffix} 2>/dev/null | head -1)
            if [ -z "$src_dir" ]; then
              echo "::error::No artifact found matching bitcoin-patched-*-${suffix}"
              exit 1
            fi
            dest_dir="${ARTIFACT_PREFIX}-${suffix}"
            mv "$src_dir" "$dest_dir"
            zip -r "${dest_dir}.zip" "$dest_dir"
          done

      - name: Upload artifacts to releases.drivechain.info
        # cross-the-world/ssh-scp-ssh-pipelines is broken and unmaintained 
        # use a fork by a random chinese company (?). pin a specific version 
        # to limit the amount of shenanigans they can pull
        uses: yitianyigexiangfa/ssh-scp-ssh-pipelines@v1.1.5
        with:
          host: 45.33.96.47
          user: root
          pass: ${{ secrets.RELEASES_SERVER_PW }}
          port: 22
          scp: |
            'L1-bitcoin-patched-*.zip' => '/var/www/html/'
